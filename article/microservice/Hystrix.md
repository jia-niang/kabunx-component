## Hystrix 是什么？

在分布式系统中，每个服务都可能会调用很多其他服务，被调用的那些服务就是依赖服务，有的时候某些依赖服务出现故障也是很正常的。

Hystrix 可以让我们在分布式系统中对服务间的调用进行控制，加入一些调用延迟或者依赖故障的容错机制。 Hystrix
通过将依赖服务进行资源隔离，进而阻止某个依赖服务出现故障的时候，这种故障在整个系统所有的依赖服务调用中进行蔓延， 同时
Hystrix 还提供故障时的 fallback 降级机制。

总而言之，Hystrix 通过这些方法帮助我们提升分布式系统的可用性和稳定性。

## Hystrix 的设计原则是什么？

hystrix 为了实现高可用性的架构，设计 hystrix 的时候，一些设计原则是什么？

* 对依赖服务调用时出现的调用延迟和调用失败进行控制和容错保护
* 在复杂的分布式系统中，阻止某一个依赖服务的故障在整个系统中蔓延
* 提供 fail-fast（快速失败）和快速恢复的支持
* 提供 fallback 优雅降级的支持
* 支持近实时的监控、报警以及运维操作

## Hystrix 要解决的问题是什么？

在复杂的分布式系统架构中，每个服务都有很多的依赖服务，而每个依赖服务都可能会故障，
如果服务没有和自己的依赖服务进行隔离，那么可能某一个依赖服务的故障就会拖垮当前这个服务

举例来说：某个服务有 30 个依赖服务，每个依赖服务的可用性非常高，已经达到了 99.99% 的高可用性

那如果出现 服务之间的调用。

## Hystrix 的更加细节的设计原则是什么？

* 阻止任何一个依赖服务耗尽所有的资源，比如 tomcat 中的所有线程资源
* 避免请求排队和积压，采用限流和 fail fast 来控制故障
* 提供 fallback 降级机制来应对故障
* 使用资源隔离技术
* 通过近实时的统计/监控/报警功能，来提高故障发现的速度
* 通过近实时的属性和配置热修改功能，来提高故障处理和恢复的速度
* 保护依赖服务调用的所有故障情况，而不仅仅只是网络故障情况

## Hystrix 是如何实现它的目标的？

* 通过 HystrixCommand 或者 HystrixObservableCommand 来封装对外部依赖的访问请求 d 这个访问请求一般会运行在独立的线程中，资源隔离
* 对于超出我们设定阈值的服务调用，直接进行超时，不允许其耗费过长时间阻塞住。
* 为每一个依赖服务维护一个独立的线程池，或者是 semaphore(信号量)，当线程池已满时，直接拒绝对这个服务的调用
* 对依赖服务的调用的成功次数、失败次数、拒绝次数、超时次数，进行统计
* 如果对一个依赖服务的调用失败次数超过了一定的阈值，自动进行熔断,在一定时间内对该服务的调用直接降级，一段时间后再自动尝试恢复
* 当一个服务调用出现失败、被拒绝、超时、短路（熔断）等异常情况时，自动调用 fallback 降级机制
* 对属性和配置的修改提供近实时的支持

## Hystrix 隔离策略

### 信号量策略

用于隔离本地代码或可快速返回的远程调用可以直接使用信号量隔离，降低线程隔离的上下文切换开销。

线程隔离会带来线程开销，有些场景（比如无网络请求场景）可能会因为用开销换隔离得不偿失，为此 hystrix 提供了信号量隔离。

主要适用于并发需求不大的依赖调用，因为如果并发需求较大，相应的信号量的数量就要设置得够大，因为 Tomcat
线程与处理线程为同一个线程，那么这个依赖调用就会占用过多的 Tomcat 线程资源，有可能会影响到其他服务的接收。

### 线程隔离策略

执行依赖代码的线程与请求线程（比如 Tomcat 线程）分离，请求线程可以自由控制离开的时间，这也是我们通常说的异步编程，Hystrix 是结合
RxJava 来实现的异步编程。

通过为每个包裹了 HystrixCommand 的 API
接口设置独立的、固定大小的线程池（hystrix.threadpool.default.coreSize）来控制并发访问量，当线程饱和的时候可以拒绝服务，防止依赖问题扩散。

系统默认采用线程隔离策略

线程隔离策略的优点如下：

* 一个依赖调用可以给予一个线程池，这个依赖的异常不会影响其他的依赖。
* 使用线程可以完全隔离业务代码，请求线程可以快速返回。
* 可以完全模拟异步调用，方便异步编程。

线程隔离策略的缺点：
使用线程池的缺点主要是增加了计算的开销。每一个依赖调用都会涉及到队列，调度，上下文切换，而这些操作都有可能在不同的线程中执行。
